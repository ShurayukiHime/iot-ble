# Bluetooth Low Energy, *A study of...*

### BLE in short
heyyyy | Bluetooth Low Energy (LE) | Bluetooth Basic Rate/ Enhanced Data Rate (BR/EDR)
--- | --- | ---
Optimized For...| Short burst data transmission | Continuous data streaming
Frequency Band  | 2.4GHz ISM Band (2.402 – 2.480 GHz Utilized) | 2.4GHz ISM Band (2.402 – 2.480 GHz Utilized)
Channels        | 40 channels with 2 MHz spacing (3 advertising channels/37 data channels) | 79 channels with 1 MHz spacing
Channel Usage |	Frequency-Hopping Spread Spectrum (FHSS) |	Frequency-Hopping Spread Spectrum (FHSS)
Modulation | 	GFSK | 	GFSK, π/4 DQPSK, 8DPSK
Power Consumption | 	~0.01x to 0.5x of reference (depending on use case) | 1 (reference value)
Data Rate |	LE 2M PHY: 2 Mb/s <br> LE 1M PHY: 1 Mb/s <br> LE Coded PHY (S=2): 500 Kb/s <br> LE Coded PHY (S=8): 125 Kb/s |	EDR PHY (8DPSK): 3 Mb/s <br> EDR PHY (π/4 DQPSK): 2 Mb/s <br> BR PHY (GFSK): 1 Mb/s 
Max Tx Power* |	Class 1: 100 mW (+20 dBm) <br> Class 1.5: 10 mW (+10 dbm) <br> Class 2: 2.5 mW (+4 dBm) <br> Class 3: 1 mW (0 dBm) |	Class 1: 100 mW (+20 dBm) <br> Class 2: 2.5 mW (+4 dBm) <br> Class 3: 1 mW (0 dBm)
Network Topologies |	Point-to-Point (including piconet) <br> Broadcast <br> Mesh |	Point-to-Point (including piconet)

Access scheme:
- Frequency Division Multiple Access: use 40 physical channels separated by 2MHz. 3 are used as primary advertising, 37 as secondary advertising and data channels. 
- Time Division Multiple Access: polling scheme in which one device transmits a packet at a predetermined time, the corresponding device responds with a packet after a predetermined interval.

## Advertisement

Physical channel divided into time units aka *events*. Data is transmitted between LE devices in packets that are positioned in these events. **Types of events**:
- Advertising
- Extended Advertising
- Periodic Advertising
- Connection

![Advertising Events](https://raw.githubusercontent.com/ShurayukiHime/iot-ble/documentation/images/adv-events.png)

- Advertisers: devices that transmit advertising packets on advertising PHY channels
- Scanners: devices that receive such advertising packets but do not have any intention to connect
	- Scanners may answer advertisement on the same channel, and the advertiser may answer back; as a consequence, the next advertisement packet is sent on a new channel
- Initiators: devices that need to connect and thus listen to advertising packets from the target device
	- The advertising packet must be a connection packet; answer may be given on the same advertising channel
	- At the same time, the connection starts and the advertising event ends

Advertising events may be used to implement a unidirectional or broadcast communication.
They may be also used to establish pair-wise bidirectional communications on data channels, or establish broadcast on secondary advertisement channels.

## Connections
- The initiator becomes the *master* and the advertiser becomes the *slave* in the piconet (?)
- Connection events are used to send data packets
	- At the beginning of each event, there is channel hopping
	- The master initiates the beginning of each event and can terminate it at any time
	- The master and the slave alternate sending packets on the same PHY channel.

![Connection Events](https://raw.githubusercontent.com/ShurayukiHime/iot-ble/documentation/images/conn-events.png)

Frequency hopping pattern is determined by a field present in the connection request packet, and it is a pseudo-random choice of the available 37 frequencies in the ISM band.
	- Frequency hopping can be adapted not to interfere with existing non-hopping connections.

## Hierarchy of layers
<center>
| Layers |
| --- |
| Physical channel |
| Physical link |
| Logical transport |
| Logical link |
| L2CAP channel |
</center>
- Connections are formed in physical links, which are contained into physical channels.
- Physical channels can contain multiple master and slave devices, and slaves are permitted to have more than one physical link at a time (but only with masters). Role changes are not permitted.
- Physical links are used as a transport for more than one logical links for asynchronous traffic, and there is a resource manager to manage the physical link through logical link multiplexing.
- L2CAP provides a channel-based abstraction to application and services
	- Carries out fragmentation and defragmnetation
	- Takes care of multiplexing and demultiplexing
- On top of L2CAP there are two additional protocols:
	- **Security Manager Protocol** implements security function between devices
	- **Attribute Protocol** provides a method to communicate small amounts of data over a fixed L2CAP channel 

## LE Topology
![Example of Bluetooth LE Topology](https://raw.githubusercontent.com/ShurayukiHime/iot-ble/documentation/images/example-topology.png)

All the details are on the specification, section 4.2. It's useless to copypasta.

## LE Procedures
### Device filtering p.
- Method used by Controllers to reduce the number of requests they receive or which they answer to
- This is not trivial considering that answer is not mandatory and this reduces power consumption.
- Both advertisers and scanners can ignore messages
- It is achieved through a white list of devices - which are actually the ones you're gonna listen / answer to.

### Advertising p.
- It can be used to make broadcast or periodic broadcast (unidirectional communication)
- It can be used as connection initiator (connectable advertising event)
- Advertising can move to secondary advertising channels or to data channels

### Scanning p.
- Used to listen to advertising messages. The s. device can ask for additional data on the (primary) advertising channel, and the advertising device answers with the data on the same channel
- If the advertisement packet is a connectable advertising event, connection can be started; both devices move to another channel and cease their advertising / scanning to enter the connected mode. After that, the ex-scanning device can still be a scanner on another advertisement channels (provided he can manage all of the connections).

### Discovering p.
- To be a discovering device, you have to listen to scannable advertising events.
- Both discovering and discoverable devices can be active in other piconets, as long as they can manage all the things at the same time.

### Connecting p.
- The only way to initiate a connection is to have both devices in the required modes:
	- Advertising connectable (and if with other active connections, can manage all of them)
	- Scanning for connections It has to initiate the procedure with a connection request specifying also the connection channel.

### Other p.
- Periodic advertising procedure
- Periodic advertising synchronization procedure
- Periodic advertising synchronized mode

## LE Security
 TODO: page 248 of Specification
